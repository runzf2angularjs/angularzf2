<?php
$this->assets('autocomplete');
$active = (!$this->search) ? ' style="display:none;" ' : '';
?>
<h1><?= __('Group access permissions') ?></h1>

<div class="panel panel-default">
    <div class="panel-heading" style='cursor: pointer' onclick="$('#panel-body-search-acl').toggle()">
        <h3 class="panel-title"><?= __('Search') ?></h3>
    </div>
    <div id="panel-body-search-acl" class="panel-body" <?=$active?>>
        <?= $this->smartForm($form) ?>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover table-condensed">
        <thead>
            <tr>
                <th rowspan="2" class="text-center"><?= __('Resource') ?></th>
                <th width="60%" colspan="<?= count($this->roles) ?>" class="text-center"><?= __('Group') ?></th>
            </tr>
            <tr>
                <?php foreach ($this->roles as $group) : ?>
                    <th class="text-center"><?= e($group['fullname']) ?></th>
                <?php endforeach; ?>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($this->resources as $resource) : ?>
                <tr>
                    <td><?= e($resource['name']) ?></td>
                    <?php foreach ($this->roles as $group) : ?>
                        <?php if ($this->dataAcl[$resource['id_acl_resource']][$group['id_acl_role']]['authorized']) : ?>
                            
                            <?php if ($this->dataAcl[$resource['id_acl_resource']][$group['id_acl_role']]['herit'] != null) : ?>
                                <td class="text-center warning">
                                    <a 
                                        href="<?= $this->smartUrlFromRoute('acl.modify', array('aclAction' => 'add', 'resourceId' => $resource['id_acl_resource'], 'groupId' => $group['id_acl_role'])) ?>"
                                        class="glyphicon glyphicon-link isHerit"
                                    >
                                    </a>
                                </td>
                            <?php else : ?>
                                <td class="text-center success">
                                    <a href="<?= $this->smartUrlFromRoute('acl.modify', array('aclAction' => 'delete', 'resourceId' => $resource['id_acl_resource'], 'groupId' => $group['id_acl_role'])) ?>" class="glyphicon glyphicon-ok isAcl"></a>
                                </td>
                            <?php endif; ?>
                        <?php else : ?>
                            <td class="text-center danger">
                                <a href="<?= $this->smartUrlFromRoute('acl.modify', array('aclAction' => 'add', 'resourceId' => $resource['id_acl_resource'], 'groupId' => $group['id_acl_role'])) ?>" class="glyphicon glyphicon-ban-circle isNotAcl"></a>
                            </td>
                        <?php endif; ?>
                    <?php endforeach; ?>
                </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</div>

<?php if (isset($this->formAction)) : ?>
    <?php if ($this->aclAction == 'delete') : ?>
        <?php $legend = __('Remove access')." '" . $dataResource['name'] . "' ".__('to')." '" . $dataRole['fullname'] . "' ?"; ?>
    <?php endif; ?>

    <?php if ($this->aclAction == 'add') : ?>
        <?php $legend = __('Add access')." '" . $dataResource['name'] . "' ".__('to')." '" . $dataRole['fullname'] . "' ?"; ?>
    <?php endif; ?>

    <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only"><?= __('Cancel') ?></span></button>
                    <h4 class="modal-title"><?=$legend?></h4>
                </div>
                <div class="modal-body text-center">
                    <span class="glyphicon glyphicon-alert"></span>
                    <?= __('Warning, you will change permissions of access rights!') ?>
                    <?= $this->smartForm($this->formAction) ?>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal"><?= __('Cancel') ?></button>
                </div>

            </div>
        </div>
    </div>
<?php endif; ?>

<div class="row">
    <div class="col-md-12 text-right">
        <span class="label label-success"><span class="glyphicon glyphicon-ok"></span> <?= __('Authorized') ?></span>
        <span class="label label-warning"><span class="glyphicon glyphicon-link"></span> <?= __('Authorized by inheritance') ?></span>
        <span class="label label-danger"><span class="glyphicon glyphicon-ban-circle"></span> <?= __('Refused') ?></span>
    </div>
</div>

<?php
$script = '
    $(document).ready(function() {
    $(\'[data-toggle="tooltip"]\').tooltip({
        placement : \'bottom\'
    });
';
if (isset($this->formAction)) {
    $script .= '
        $(".modal").modal();
    ';
}
$script .= '
        $(".isAcl").mouseover(function () {
            $(this).removeClass("glyphicon-ok");
            $(this).addClass("glyphicon-cog");
        });
        $(".isAcl").mouseout(function () {
            $(this).removeClass("glyphicon-cog");
            $(this).addClass("glyphicon-ok");
        });
        
        $(".isHerit").mouseover(function () {
            $(this).removeClass("glyphicon-link");
            $(this).addClass("glyphicon-cog");
        });
        $(".isHerit").mouseout(function () {
            $(this).removeClass("glyphicon-cog");
            $(this).addClass("glyphicon-link");
        });

        $(".isNotAcl").mouseover(function () {
            $(this).removeClass("glyphicon-ban-circle");
            $(this).addClass("glyphicon-cog");
        });
        $(".isNotAcl").mouseout(function () {
            $(this).removeClass("glyphicon-cog");
            $(this).addClass("glyphicon-ban-circle");
        });
    });
';
$this->inlineScript()->appendScript($script);
